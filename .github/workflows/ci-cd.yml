name: è‚¡ç¥¨åˆ†æç³»ç»Ÿ CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  DOCKER_IMAGE: tuoyongjun1987/gupiao-stock-analysis
  DOCKER_TAG: ${{ github.sha }}

jobs:
  test:
    name: è¿è¡Œæµ‹è¯•
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ç¼“å­˜ä¾èµ–
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements_minimal_fixed.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements_minimal_fixed.txt
        
    - name: è¿è¡ŒåŸºç¡€æµ‹è¯•
      run: |
        python -c "import streamlit, pandas, numpy, yfinance, plotly; print('âœ… æ‰€æœ‰æ ¸å¿ƒä¾èµ–å¯¼å…¥æˆåŠŸ')"
        
    - name: æ£€æŸ¥åº”ç”¨æ–‡ä»¶
      run: |
        if [ -f "src/ui/streamlit_app.py" ]; then
          echo "âœ… ä¸»åº”ç”¨æ–‡ä»¶å­˜åœ¨"
        else
          echo "âŒ ä¸»åº”ç”¨æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi

  build:
    name: æ„å»ºDockeré•œåƒ
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: é¡¹ç›®æ¸…ç†ä¼˜åŒ–
      run: |
        echo "ğŸ§¹ æ¸…ç†é¡¹ç›®ä»¥å‡å°‘é•œåƒå¤§å°..."
        
        # æ¸…ç†Pythonç¼“å­˜
        find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
        find . -type f -name "*.pyc" -delete 2>/dev/null || true
        find . -type f -name "*.pyo" -delete 2>/dev/null || true
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        find . -type f -name "*.tmp" -delete 2>/dev/null || true
        find . -type f -name "*.bak" -delete 2>/dev/null || true
        find . -type f -name "*.log" -delete 2>/dev/null || true
        find . -type f -name "*~" -delete 2>/dev/null || true
        
        # æ¸…ç†ç³»ç»Ÿæ–‡ä»¶
        find . -type f -name ".DS_Store" -delete 2>/dev/null || true
        find . -type f -name "Thumbs.db" -delete 2>/dev/null || true
        find . -type f -name "*.Zone.Identifier" -delete 2>/dev/null || true
        
        # æ¸…ç†æ•°æ®ç›®å½•ï¼ˆä¿æŒç»“æ„ï¼‰
        rm -rf data/* cache/* logs/* exports/* models/* 2>/dev/null || true
        touch data/.gitkeep cache/.gitkeep logs/.gitkeep exports/.gitkeep models/.gitkeep
        
        # æ˜¾ç¤ºæ¸…ç†åçš„å¤§å°
        echo "ğŸ“Š æ¸…ç†åçš„æ„å»ºä¸Šä¸‹æ–‡å¤§å°:"
        du -sh . 2>/dev/null || echo "æ— æ³•è®¡ç®—å¤§å°"
        
        echo "âœ… é¡¹ç›®æ¸…ç†å®Œæˆ"
      
    - name: è®¾ç½®Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ç™»å½•Docker Hub
      uses: docker/login-action@v3
      with:
        username: tuoyongjun1987
        password: ${{ secrets.DOCKER_HUB_TOKEN }}
        
    - name: æ„å»ºå¹¶æ¨é€Dockeré•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ env.DOCKER_IMAGE }}:latest
          ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy-test:
    name: éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ddns.52trz.com
        username: root
        password: ${{ secrets.TEST_SERVER_PASSWORD }}
        port: 22
        script: |
          # åœæ­¢ç°æœ‰å®¹å™¨
          docker stop gupiao-app || true
          docker rm gupiao-app || true
          
          # æ¸…ç†æ—§é•œåƒ
          docker image prune -f
          
          # æ‹‰å–æœ€æ–°é•œåƒ
          docker pull ${{ env.DOCKER_IMAGE }}:latest
          
          # å¯åŠ¨æ–°å®¹å™¨
          docker run -d \
            --name gupiao-app \
            --restart unless-stopped \
            -p 8501:8501 \
            -e ENVIRONMENT=test \
            ${{ env.DOCKER_IMAGE }}:latest
          
          # ç­‰å¾…åº”ç”¨å¯åŠ¨
          sleep 30
          
          # å¥åº·æ£€æŸ¥
          if curl -f http://localhost:8501/_stcore/health; then
            echo "âœ… æµ‹è¯•æœåŠ¡å™¨éƒ¨ç½²æˆåŠŸ"
            echo "ğŸŒ è®¿é—®åœ°å€: http://ddns.52trz.com:8501"
          else
            echo "âŒ æµ‹è¯•æœåŠ¡å™¨éƒ¨ç½²å¤±è´¥"
            exit 1
          fi

  deploy-production:
    name: éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
    runs-on: ubuntu-latest
    needs: [build, deploy-test]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: 47.94.225.76
        username: root
        password: ${{ secrets.PROD_SERVER_PASSWORD }}
        port: 22
        script: |
          # åœæ­¢ç°æœ‰å®¹å™¨
          docker stop gupiao-app || true
          docker rm gupiao-app || true
          
          # æ¸…ç†æ—§é•œåƒ
          docker image prune -f
          
          # æ‹‰å–æœ€æ–°é•œåƒ
          docker pull ${{ env.DOCKER_IMAGE }}:latest
          
          # å¯åŠ¨æ–°å®¹å™¨
          docker run -d \
            --name gupiao-app \
            --restart unless-stopped \
            -p 8501:8501 \
            -e ENVIRONMENT=production \
            -v /var/log/gupiao:/app/logs \
            ${{ env.DOCKER_IMAGE }}:latest
          
          # ç­‰å¾…åº”ç”¨å¯åŠ¨
          sleep 30
          
          # å¥åº·æ£€æŸ¥
          if curl -f http://localhost:8501/_stcore/health; then
            echo "âœ… ç”Ÿäº§æœåŠ¡å™¨éƒ¨ç½²æˆåŠŸ"
            echo "ğŸŒ è®¿é—®åœ°å€: http://47.94.225.76:8501"
          else
            echo "âŒ ç”Ÿäº§æœåŠ¡å™¨éƒ¨ç½²å¤±è´¥"
            exit 1
          fi
          
          # è®¾ç½®é˜²ç«å¢™è§„åˆ™(å¦‚æœéœ€è¦)
          ufw allow 8501/tcp || true
          ufw allow 80/tcp || true

  notify:
    name: éƒ¨ç½²é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: always()
    
    steps:
    - name: å‘é€éƒ¨ç½²é€šçŸ¥
      run: |
        if [ "${{ needs.deploy-production.result }}" = "success" ]; then
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸ“± æµ‹è¯•æœåŠ¡å™¨: http://ddns.52trz.com:8501"
          echo "ğŸŒ ç”Ÿäº§æœåŠ¡å™¨: http://47.94.225.76:8501"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
        fi
