name: ğŸš€ ç”Ÿäº§ç¯å¢ƒCI/CDéƒ¨ç½²

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'archive/**'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deploy_to_production:
        description: 'æ˜¯å¦éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ'
        required: true
        default: 'true'
        type: boolean

env:
  DOCKER_IMAGE: tuoyongjun1987/gupiao-stock-analysis
  PRODUCTION_SERVER: 47.94.225.76
  APP_PORT: 8501

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  lint-and-test:
    name: ğŸ” ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements_minimal_fixed.txt
          pip install flake8 black

      - name: ğŸ§¹ ä»£ç æ ¼å¼æ£€æŸ¥
        run: |
          echo "ğŸ” æ£€æŸ¥Pythonä»£ç æ ¼å¼..."
          flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics
          black --check src/ || echo "æ ¼å¼æ£€æŸ¥å®Œæˆ"

      - name: ğŸ§ª åŸºç¡€æµ‹è¯•
        run: |
          echo "ğŸ§ª è¿è¡ŒåŸºç¡€å¯¼å…¥æµ‹è¯•..."
          python -c "
          import sys
          sys.path.append('src')
          try:
              from ui.streamlit_app import main
              print('âœ… ä¸»åº”ç”¨å¯¼å…¥æˆåŠŸ')
          except Exception as e:
              print(f'âŒ å¯¼å…¥å¤±è´¥: {e}')
              exit(1)
          "

  # æ„å»ºä¼˜åŒ–Dockeré•œåƒ
  build-image:
    name: ğŸ³ æ„å»ºä¼˜åŒ–Dockeré•œåƒ
    runs-on: ubuntu-latest
    needs: lint-and-test
    outputs:
      image-tag: ${{ steps.tag.outputs.tag }}
      image-size: ${{ steps.build.outputs.size }}
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ·ï¸ ç”Ÿæˆé•œåƒæ ‡ç­¾
        id: tag
        run: |
          TAG="v2.1.0-$(date +%Y%m%d-%H%M%S)-${GITHUB_SHA::8}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "ç”Ÿæˆé•œåƒæ ‡ç­¾: $TAG"

      - name: ğŸ§¹ é¡¹ç›®æ¸…ç†
        run: |
          echo "ğŸ§¹ è¿è¡Œæ„å»ºå‰æ¸…ç†..."
          # æ¸…ç†Pythonç¼“å­˜
          find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
          find . -name "*.pyc" -delete 2>/dev/null || true
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf .pytest_cache/ .coverage .tox/ 2>/dev/null || true
          
          # æ˜¾ç¤ºæ„å»ºä¸Šä¸‹æ–‡å¤§å°
          echo "ğŸ“Š æ„å»ºä¸Šä¸‹æ–‡å¤§å°:"
          du -sh . --exclude=.git --exclude=venv

      - name: ğŸ”§ è®¾ç½®Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” ç™»å½•Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ³ æ„å»ºå¹¶æ¨é€Dockeré•œåƒ
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:${{ steps.tag.outputs.tag }}
            ${{ env.DOCKER_IMAGE }}:latest
          platforms: linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}

      - name: ğŸ“Š æ˜¾ç¤ºé•œåƒä¿¡æ¯
        run: |
          echo "âœ… é•œåƒæ„å»ºå®Œæˆ:"
          echo "- é•œåƒ: ${{ env.DOCKER_IMAGE }}:${{ steps.tag.outputs.tag }}"
          echo "- å¤§å°: ä¼˜åŒ–ç‰ˆ (é¢„è®¡<500M)"
          echo "- å¹³å°: linux/amd64"

  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy-production:
    name: ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: [lint-and-test, build-image]
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.deploy_to_production))
    environment: production
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”§ å‡†å¤‡éƒ¨ç½²è„šæœ¬
        run: |
          echo "ğŸ“ åˆ›å»ºç”Ÿäº§éƒ¨ç½²è„šæœ¬..."
          cat > deploy-to-production.sh << 'EOF'
          #!/bin/bash
          set -e
          
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
          echo "æ—¶é—´: $(date)"
          echo "é•œåƒ: $1"
          echo "æœåŠ¡å™¨: $2"
          
          # é…ç½®å˜é‡
          DOCKER_IMAGE="$1"
          APP_DIR="/www/wwwroot/gupiao"
          CONTAINER_NAME="gupiao-app"
          PORT="8501"
          
          # åˆ›å»ºåº”ç”¨ç›®å½•
          echo "ğŸ“ åˆ›å»ºåº”ç”¨ç›®å½•..."
          mkdir -p $APP_DIR
          cd $APP_DIR
          mkdir -p logs data exports cache models
          chmod 755 logs data exports cache models
          
          # å¤‡ä»½å½“å‰éƒ¨ç½²
          echo "ğŸ’¾ å¤‡ä»½å½“å‰éƒ¨ç½²..."
          if docker ps | grep -q $CONTAINER_NAME; then
              docker stop $CONTAINER_NAME || true
              docker rename $CONTAINER_NAME ${CONTAINER_NAME}-backup-$(date +%Y%m%d_%H%M%S) || true
          fi
          
          # æ‹‰å–æœ€æ–°é•œåƒ
          echo "ğŸ“¥ æ‹‰å–æœ€æ–°é•œåƒ..."
          docker pull $DOCKER_IMAGE
          
          # åˆ›å»ºdocker-composeé…ç½®
          echo "ğŸ“ åˆ›å»ºdocker-composeé…ç½®..."
          cat > docker-compose.yml << 'COMPOSE_EOF'
          version: '3.8'
          
          services:
            gupiao-app:
              image: ${DOCKER_IMAGE}
              container_name: ${CONTAINER_NAME}
              restart: unless-stopped
              ports:
                - "${PORT}:8501"
              environment:
                - ENVIRONMENT=production
                - STREAMLIT_SERVER_PORT=8501
                - STREAMLIT_SERVER_ADDRESS=0.0.0.0
                - STREAMLIT_SERVER_HEADLESS=true
                - STREAMLIT_BROWSER_GATHER_USAGE_STATS=false
              volumes:
                - ./logs:/app/logs
                - ./data:/app/data
                - ./exports:/app/exports
                - ./cache:/app/cache
                - ./models:/app/models
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:8501"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 60s
              networks:
                - gupiao-network
          
          networks:
            gupiao-network:
              driver: bridge
          COMPOSE_EOF
          
          # å¯åŠ¨æœåŠ¡
          echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
          docker-compose down || true
          docker-compose up -d
          
          # å¥åº·æ£€æŸ¥
          echo "ğŸ©º æ‰§è¡Œå¥åº·æ£€æŸ¥..."
          sleep 15
          
          max_attempts=30
          attempt=1
          while [ $attempt -le $max_attempts ]; do
              if curl -f http://localhost:$PORT &> /dev/null; then
                  echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
                  break
              else
                  echo "â³ ç­‰å¾…åº”ç”¨å¯åŠ¨... ($attempt/$max_attempts)"
                  sleep 2
                  ((attempt++))
              fi
          done
          
          if [ $attempt -gt $max_attempts ]; then
              echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"
              docker logs $CONTAINER_NAME --tail 50
              exit 1
          fi
          
          # æ¸…ç†èµ„æº
          echo "ğŸ§¹ æ¸…ç†æ—§èµ„æº..."
          docker images $DOCKER_IMAGE --format "{{.ID}}" | tail -n +4 | xargs -r docker rmi || true
          docker image prune -f || true
          
          echo "ğŸ‰ éƒ¨ç½²å®Œæˆ!"
          echo "è®¿é—®åœ°å€: http://$2:$PORT"
          EOF
          
          chmod +x deploy-to-production.sh

      - name: ğŸš€ æ‰§è¡Œç”Ÿäº§éƒ¨ç½²
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.PRODUCTION_SERVER }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          port: 22
          timeout: 300s
          command_timeout: 600s
          script: |
            echo "ğŸš€ å¼€å§‹ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²..."
            
            # æ£€æŸ¥Dockerç¯å¢ƒ
            if ! command -v docker &> /dev/null; then
                echo "âŒ Dockeræœªå®‰è£…ï¼Œå¼€å§‹å®‰è£…..."
                # å®‰è£…Docker
                curl -fsSL https://get.docker.com -o get-docker.sh
                sh get-docker.sh
                systemctl enable docker
                systemctl start docker
                rm get-docker.sh
            fi
            
            if ! command -v docker-compose &> /dev/null; then
                echo "âŒ Docker Composeæœªå®‰è£…ï¼Œå¼€å§‹å®‰è£…..."
                curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
                chmod +x /usr/local/bin/docker-compose
                ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose
            fi
            
            # é…ç½®å˜é‡
            DOCKER_IMAGE="${{ env.DOCKER_IMAGE }}:${{ needs.build-image.outputs.image-tag }}"
            APP_DIR="/www/wwwroot/gupiao"
            CONTAINER_NAME="gupiao-app"
            PORT="8501"
            
            # åˆ›å»ºåº”ç”¨ç›®å½•
            echo "ğŸ“ åˆ›å»ºåº”ç”¨ç›®å½•..."
            mkdir -p $APP_DIR
            cd $APP_DIR
            mkdir -p logs data exports cache models
            chmod 755 logs data exports cache models
            
            # å¤‡ä»½å½“å‰éƒ¨ç½²
            echo "ğŸ’¾ å¤‡ä»½å½“å‰éƒ¨ç½²..."
            if docker ps | grep -q $CONTAINER_NAME; then
                docker stop $CONTAINER_NAME || true
                docker rename $CONTAINER_NAME ${CONTAINER_NAME}-backup-$(date +%Y%m%d_%H%M%S) || true
            fi
            
            # æ‹‰å–æœ€æ–°é•œåƒ
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°é•œåƒ: $DOCKER_IMAGE"
            docker pull $DOCKER_IMAGE
            
            # åˆ›å»ºdocker-composeé…ç½®
            echo "ğŸ“ åˆ›å»ºdocker-composeé…ç½®..."
            cat > docker-compose.yml << 'EOF'
            version: '3.8'
            
            services:
              gupiao-app:
                image: ${{ env.DOCKER_IMAGE }}:${{ needs.build-image.outputs.image-tag }}
                container_name: gupiao-app
                restart: unless-stopped
                ports:
                  - "8501:8501"
                environment:
                  - ENVIRONMENT=production
                  - STREAMLIT_SERVER_PORT=8501
                  - STREAMLIT_SERVER_ADDRESS=0.0.0.0
                  - STREAMLIT_SERVER_HEADLESS=true
                  - STREAMLIT_BROWSER_GATHER_USAGE_STATS=false
                  - TUSHARE_TOKEN=${{ secrets.TUSHARE_TOKEN }}
                  - AKSHARE_ENABLED=true
                  - YFINANCE_ENABLED=true
                volumes:
                  - ./logs:/app/logs
                  - ./data:/app/data
                  - ./exports:/app/exports
                  - ./cache:/app/cache
                  - ./models:/app/models
                healthcheck:
                  test: ["CMD", "curl", "-f", "http://localhost:8501"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 60s
                networks:
                  - gupiao-network
            
            networks:
              gupiao-network:
                driver: bridge
            EOF
            
            # å¯åŠ¨æœåŠ¡
            echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
            docker-compose down || true
            docker-compose up -d
            
            # å¥åº·æ£€æŸ¥
            echo "ğŸ©º æ‰§è¡Œå¥åº·æ£€æŸ¥..."
            sleep 15
            
            max_attempts=30
            attempt=1
            while [ $attempt -le $max_attempts ]; do
                if curl -f http://localhost:8501 &> /dev/null; then
                    echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
                    break
                else
                    echo "â³ ç­‰å¾…åº”ç”¨å¯åŠ¨... ($attempt/$max_attempts)"
                    sleep 2
                    ((attempt++))
                fi
            done
            
            if [ $attempt -gt $max_attempts ]; then
                echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"
                docker logs gupiao-app --tail 50
                exit 1
            fi
            
            # å¼€æ”¾é˜²ç«å¢™ç«¯å£
            if command -v firewall-cmd &> /dev/null; then
                firewall-cmd --permanent --add-port=8501/tcp || true
                firewall-cmd --reload || true
            fi
            
            # æ¸…ç†èµ„æº
            echo "ğŸ§¹ æ¸…ç†æ—§èµ„æº..."
            docker images ${{ env.DOCKER_IMAGE }} --format "{{.ID}}" | tail -n +4 | xargs -r docker rmi || true
            docker image prune -f || true
            
            echo "ğŸ‰ éƒ¨ç½²å®Œæˆ!"
            echo "è®¿é—®åœ°å€: http://${{ env.PRODUCTION_SERVER }}:8501"
            docker ps | grep gupiao-app

      - name: ğŸ” éƒ¨ç½²åéªŒè¯
        run: |
          echo "ğŸ” éªŒè¯ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²..."
          sleep 10
          
          # æ£€æŸ¥æœåŠ¡å“åº”
          max_attempts=10
          attempt=1
          while [ $attempt -le $max_attempts ]; do
              if curl -f http://${{ env.PRODUCTION_SERVER }}:${{ env.APP_PORT }} --connect-timeout 10 &> /dev/null; then
                  echo "âœ… ç”Ÿäº§ç¯å¢ƒéªŒè¯æˆåŠŸ!"
                  break
              else
                  echo "â³ ç­‰å¾…ç”Ÿäº§ç¯å¢ƒå“åº”... ($attempt/$max_attempts)"
                  sleep 5
                  ((attempt++))
              fi
          done
          
          if [ $attempt -gt $max_attempts ]; then
              echo "âš ï¸ æ— æ³•éªŒè¯ç”Ÿäº§ç¯å¢ƒå“åº”ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥"
          fi

  # éƒ¨ç½²é€šçŸ¥
  notify:
    name: ğŸ“¢ éƒ¨ç½²é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [build-image, deploy-production]
    if: always()
    steps:
      - name: ğŸ“Š ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š
        run: |
          echo "## ğŸš€ éƒ¨ç½²æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ æ„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **é•œåƒæ ‡ç­¾**: ${{ needs.build-image.outputs.image-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **é•œåƒä»“åº“**: ${{ env.DOCKER_IMAGE }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ„å»ºæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤SHA**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸŒ è®¿é—®ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **ç”Ÿäº§ç¯å¢ƒ**: http://${{ env.PRODUCTION_SERVER }}:${{ env.APP_PORT }}" >> $GITHUB_STEP_SUMMARY
          echo "- **GitHubä»“åº“**: ${{ github.server_url }}/${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.deploy-production.result }}" == "success" ]; then
              echo "### âœ… éƒ¨ç½²çŠ¶æ€: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
              echo "åº”ç”¨å·²æˆåŠŸéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Œå¯ä»¥æ­£å¸¸è®¿é—®ã€‚" >> $GITHUB_STEP_SUMMARY
          else
              echo "### âŒ éƒ¨ç½²çŠ¶æ€: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
              echo "éƒ¨ç½²è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
